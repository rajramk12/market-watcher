<div style="padding: 20px; font-family: Arial, sans-serif;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h1 style="margin: 0;">Sidekiq Job Processing Monitor</h1>
    <button onclick="location.reload()" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
      ðŸ”„ Refresh
    </button>
  </div>

  <!-- Overall Stats -->
  <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h2>Overall Statistics</h2>
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
      <div style="background: white; padding: 10px; border-radius: 3px; border-left: 4px solid #4CAF50;">
        <p style="margin: 0; font-size: 12px; color: #666;">Processed</p>
        <p style="margin: 0; font-size: 24px; font-weight: bold;"><%= @stats.processed %></p>
      </div>

      <div style="background: white; padding: 10px; border-radius: 3px; border-left: 4px solid #2196F3;">
        <p style="margin: 0; font-size: 12px; color: #666;">Enqueued</p>
        <p style="margin: 0; font-size: 24px; font-weight: bold;"><%= @stats.enqueued %></p>
      </div>

      <div style="background: white; padding: 10px; border-radius: 3px; border-left: 4px solid #FF9800;">
        <p style="margin: 0; font-size: 12px; color: #666;">Scheduled</p>
        <p style="margin: 0; font-size: 24px; font-weight: bold;"><%= @stats.scheduled_size %></p>
      </div>

      <div style="background: white; padding: 10px; border-radius: 3px; border-left: 4px solid #f44336;">
        <p style="margin: 0; font-size: 12px; color: #666;">Failed</p>
        <p style="margin: 0; font-size: 24px; font-weight: bold;"><%= @stats.failed %></p>
      </div>
    </div>
  </div>

  <!-- Active Workers -->
  <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ddd;">
    <h2>Active Workers (<%= @workers.size %>)</h2>
    <% if @workers.any? %>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
            <th style="padding: 10px; text-align: left;">Worker</th>
            <th style="padding: 10px; text-align: left;">Queue</th>
            <th style="padding: 10px; text-align: left;">Job Class</th>
            <th style="padding: 10px; text-align: left;">Started At</th>
            <th style="padding: 10px; text-align: left;">Elapsed (s)</th>
          </tr>
        </thead>
        <tbody>
          <% @workers.each do |worker| %>
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 10px;"><code style="background: #f0f0f0; padding: 3px 5px; border-radius: 3px;"><%= worker[:id] %></code></td>
              <td style="padding: 10px;"><span style="background: #E3F2FD; padding: 3px 8px; border-radius: 3px;"><%= worker[:queue] %></span></td>
              <td style="padding: 10px;"><code><%= worker[:worker] %></code></td>
              <td style="padding: 10px; font-size: 12px;"><%= worker[:started_at].strftime('%Y-%m-%d %H:%M:%S') %></td>
              <td style="padding: 10px;"><strong><%= worker[:elapsed] %></strong></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p style="color: #999; margin: 10px 0;">No active workers</p>
    <% end %>
  </div>

  <!-- Queue Status -->
  <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ddd;">
    <h2>Queues Status</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
      <% @queues.each do |queue_name, queue_data| %>
        <div style="background: #f9f9f9; padding: 12px; border-radius: 3px; border-left: 3px solid #2196F3; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <p style="margin: 0; font-weight: bold; color: #333;"><%= queue_name %></p>
            <p style="margin: 5px 0; font-size: 12px; color: #666;">
              <strong><%= queue_data[:size] %></strong> jobs queued
            </p>
            <p style="margin: 5px 0; font-size: 12px; color: #666;">
              Latency: <strong><%= queue_data[:latency].round(2) %>s</strong>
            </p>
          </div>
          <% if queue_data[:size] > 0 %>
            <%= form_with url: admin_clear_queue_path, method: :post, style: 'margin: 0;' do |f| %>
              <%= f.hidden_field :queue, value: queue_name %>
              <%= f.submit 'Clear', style: 'padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;' %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- File Processing Jobs -->
  <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ddd;">
    <h2>Recent File Processing Jobs (Ingest Queue)</h2>
    <% ingest_queue = @queues['ingest'] %>
    <% if ingest_queue && ingest_queue[:jobs].any? %>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
            <th style="padding: 10px; text-align: left;">Job Class</th>
            <th style="padding: 10px; text-align: left;">Arguments</th>
            <th style="padding: 10px; text-align: left;">Added At</th>
          </tr>
        </thead>
        <tbody>
          <% ingest_queue[:jobs].each do |job| %>
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 10px;"><code><%= job.item['class'] %></code></td>
              <td style="padding: 10px; font-size: 12px;">
                <code style="background: #f0f0f0; padding: 3px 5px; border-radius: 3px;">
                  <%= job.item['args'].inspect %>
                </code>
              </td>
              <td style="padding: 10px; font-size: 12px;"><%= Time.at(job.item['created_at']).strftime('%Y-%m-%d %H:%M:%S') %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p style="color: #999; margin: 10px 0;">No jobs in ingest queue</p>
    <% end %>
  </div>

  <!-- Failed Jobs -->
  <div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2 style="margin: 0;">Failed Jobs (<%= @failed_jobs[:total] %>)</h2>
      <% if @failed_jobs[:total] > 0 %>
        <div>
          <%= form_with url: admin_retry_failed_path, method: :post, style: 'display: inline; margin-right: 10px;' do %>
            <%= submit_tag 'Retry All', style: 'padding: 6px 12px; background: #FF9800; color: white; border: none; border-radius: 3px; cursor: pointer;' %>
          <% end %>
          <%= form_with url: admin_clear_failed_path, method: :post, style: 'display: inline;' do %>
            <%= submit_tag 'Clear All', style: 'padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;' %>
          <% end %>
        </div>
      <% end %>
    </div>
    <% if @failed_jobs[:sample].any? %>
      <div style="background: #FFEBEE; padding: 10px; border-radius: 3px; margin: 10px 0;">
        <p style="margin: 0; color: #c62828;"><strong>âš  <%= @failed_jobs[:total] %> failed jobs detected</strong></p>
      </div>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
            <th style="padding: 10px; text-align: left;">Job Class</th>
            <th style="padding: 10px; text-align: left;">Error</th>
            <th style="padding: 10px; text-align: left;">Failed At</th>
          </tr>
        </thead>
        <tbody>
          <% @failed_jobs[:sample].each do |job| %>
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 10px;"><code><%= job.item['class'] %></code></td>
              <td style="padding: 10px; font-size: 12px; color: #d32f2f;">
                <%= job.item['error_message'] || 'Unknown error' %>
              </td>
              <td style="padding: 10px; font-size: 12px;"><%= job.item['failed_at'] %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <p style="margin: 10px 0; font-size: 12px; color: #666;">
        Showing <%= [@failed_jobs[:sample].size, 5].min %> of <%= @failed_jobs[:total] %> failed jobs.
        <%= link_to 'View all', admin_sidekiq_dashboard_path %>
      </p>
    <% else %>
      <p style="color: #4CAF50; margin: 10px 0; font-weight: bold;">âœ“ No failed jobs</p>
    <% end %>
  </div>

  <!-- Links -->
  <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
    <p style="margin: 10px 0;">
      <%= link_to 'Full Sidekiq Dashboard', admin_sidekiq_dashboard_path, style: 'color: #2196F3; text-decoration: none; font-weight: bold;' %>
    </p>
    <p style="margin: 10px 0;">
      <%= link_to 'Back to Admin', admin_uploads_path, style: 'color: #666; text-decoration: none;' %>
    </p>
  </div>
</div>

  <!-- Overall Stats -->
  <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h2>Overall Statistics</h2>
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
      <div style="background: white; padding: 10px; border-radius: 3px; border-left: 4px solid #4CAF50;">
        <p style="margin: 0; font-size: 12px; color: #666;">Processed</p>
        <p style="margin: 0; font-size: 24px; font-weight: bold;"><%= @stats.processed %></p>
      </div>

      <div style="background: white; padding: 10px; border-radius: 3px; border-left: 4px solid #2196F3;">
        <p style="margin: 0; font-size: 12px; color: #666;">Enqueued</p>
        <p style="margin: 0; font-size: 24px; font-weight: bold;"><%= @stats.enqueued %></p>
      </div>

      <div style="background: white; padding: 10px; border-radius: 3px; border-left: 4px solid #FF9800;">
        <p style="margin: 0; font-size: 12px; color: #666;">Scheduled</p>
        <p style="margin: 0; font-size: 24px; font-weight: bold;"><%= @stats.scheduled_size %></p>
      </div>

      <div style="background: white; padding: 10px; border-radius: 3px; border-left: 4px solid #f44336;">
        <p style="margin: 0; font-size: 12px; color: #666;">Failed</p>
        <p style="margin: 0; font-size: 24px; font-weight: bold;"><%= @stats.failed %></p>
      </div>
    </div>
  </div>

  <!-- Active Workers -->
  <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ddd;">
    <h2>Active Workers (<%= @workers.size %>)</h2>
    <% if @workers.any? %>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
            <th style="padding: 10px; text-align: left;">Worker</th>
            <th style="padding: 10px; text-align: left;">Queue</th>
            <th style="padding: 10px; text-align: left;">Job Class</th>
            <th style="padding: 10px; text-align: left;">Started At</th>
            <th style="padding: 10px; text-align: left;">Elapsed (s)</th>
          </tr>
        </thead>
        <tbody>
          <% @workers.each do |worker| %>
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 10px;"><code style="background: #f0f0f0; padding: 3px 5px; border-radius: 3px;"><%= worker[:id] %></code></td>
              <td style="padding: 10px;"><span style="background: #E3F2FD; padding: 3px 8px; border-radius: 3px;"><%= worker[:queue] %></span></td>
              <td style="padding: 10px;"><code><%= worker[:worker] %></code></td>
              <td style="padding: 10px; font-size: 12px;"><%= worker[:started_at].strftime('%Y-%m-%d %H:%M:%S') %></td>
              <td style="padding: 10px;"><strong><%= worker[:elapsed] %></strong></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p style="color: #999; margin: 10px 0;">No active workers</p>
    <% end %>
  </div>

  <!-- Queue Status -->
  <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ddd;">
    <h2>Queues Status</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
      <% @queues.each do |queue_name, queue_data| %>
        <div style="background: #f9f9f9; padding: 12px; border-radius: 3px; border-left: 3px solid #2196F3;">
          <p style="margin: 0; font-weight: bold; color: #333;"><%= queue_name %></p>
          <p style="margin: 5px 0; font-size: 12px; color: #666;">
            <strong><%= queue_data[:size] %></strong> jobs queued
          </p>
          <p style="margin: 5px 0; font-size: 12px; color: #666;">
            Latency: <strong><%= queue_data[:latency].round(2) %>s</strong>
          </p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- File Processing Jobs -->
  <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ddd;">
    <h2>Recent File Processing Jobs (Ingest Queue)</h2>
    <% ingest_queue = @queues['ingest'] %>
    <% if ingest_queue && ingest_queue[:jobs].any? %>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
            <th style="padding: 10px; text-align: left;">Job Class</th>
            <th style="padding: 10px; text-align: left;">Arguments</th>
            <th style="padding: 10px; text-align: left;">Added At</th>
          </tr>
        </thead>
        <tbody>
          <% ingest_queue[:jobs].each do |job| %>
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 10px;"><code><%= job.item['class'] %></code></td>
              <td style="padding: 10px; font-size: 12px;">
                <code style="background: #f0f0f0; padding: 3px 5px; border-radius: 3px;">
                  <%= job.item['args'].inspect %>
                </code>
              </td>
              <td style="padding: 10px; font-size: 12px;"><%= Time.at(job.item['created_at']).strftime('%Y-%m-%d %H:%M:%S') %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p style="color: #999; margin: 10px 0;">No jobs in ingest queue</p>
    <% end %>
  </div>

  <!-- Failed Jobs -->
  <div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #ddd;">
    <h2>Failed Jobs (<%= @failed_jobs[:total] %>)</h2>
    <% if @failed_jobs[:sample].any? %>
      <div style="background: #FFEBEE; padding: 10px; border-radius: 3px; margin-bottom: 10px;">
        <p style="margin: 0; color: #c62828;"><strong>âš  <%= @failed_jobs[:total] %> failed jobs detected</strong></p>
      </div>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
            <th style="padding: 10px; text-align: left;">Job Class</th>
            <th style="padding: 10px; text-align: left;">Error</th>
            <th style="padding: 10px; text-align: left;">Failed At</th>
          </tr>
        </thead>
        <tbody>
          <% @failed_jobs[:sample].each do |job| %>
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 10px;"><code><%= job.item['class'] %></code></td>
              <td style="padding: 10px; font-size: 12px; color: #d32f2f;">
                <%= job.item['error_message'] || 'Unknown error' %>
              </td>
              <td style="padding: 10px; font-size: 12px;"><%= job.item['failed_at'] %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <p style="margin: 10px 0; font-size: 12px; color: #666;">
        Showing <%= [@failed_jobs[:sample].size, 5].min %> of <%= @failed_jobs[:total] %> failed jobs.
        <%= link_to 'View all', admin_sidekiq_dashboard_path %>
      </p>
    <% else %>
      <p style="color: #4CAF50; margin: 10px 0; font-weight: bold;">âœ“ No failed jobs</p>
    <% end %>
  </div>

  <!-- Links -->
  <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
    <p style="margin: 10px 0;">
      <%= link_to 'Full Sidekiq Dashboard', admin_sidekiq_dashboard_path, style: 'color: #2196F3; text-decoration: none; font-weight: bold;' %>
    </p>
    <p style="margin: 10px 0;">
      <%= link_to 'Back to Admin', admin_uploads_path, style: 'color: #666; text-decoration: none;' %>
    </p>
  </div>
</div>
